# Azure DevOps Pipeline for Streaky Habit Tracker
# Stages: Build → Test → Deploy

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    exclude:
      - README.md
      - docs/**
      - .gitignore

pr:
  branches:
    include:
      - main
      - develop

variables:
  pythonVersion: '3.13'
  azureServiceConnection: 'streaky-azure-connection'  # Update with your service connection name
  webAppName: 'streaky-api'  # Update with your App Service name
  resourceGroup: 'streaky-prod-rg'

stages:
  - stage: Build
    displayName: 'Build Application'
    jobs:
      - job: BuildBackend
        displayName: 'Build Python Backend'
        pool:
          vmImage: 'ubuntu-latest'
        
        steps:
          - task: UsePythonVersion@0
            displayName: 'Use Python $(pythonVersion)'
            inputs:
              versionSpec: '$(pythonVersion)'
          
          - script: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt -r requirements-dev.txt
            displayName: 'Install Dependencies'
          
          - script: |
              ruff check app/ tests/
            displayName: 'Run Ruff Linting'
            continueOnError: false
          
          - script: |
              mypy app/
            displayName: 'Run MyPy Type Checking'
            continueOnError: true
          
          - task: ArchiveFiles@2
            displayName: 'Archive Application Files'
            inputs:
              rootFolderOrFile: '$(System.DefaultWorkingDirectory)'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
              replaceExistingArchive: true
          
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Build Artifacts'
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'drop'
              publishLocation: 'Container'

  - stage: Test
    displayName: 'Run Tests'
    dependsOn: Build
    jobs:
      - job: RunTests
        displayName: 'Execute Test Suite'
        pool:
          vmImage: 'ubuntu-latest'
        
        steps:
          - task: UsePythonVersion@0
            displayName: 'Use Python $(pythonVersion)'
            inputs:
              versionSpec: '$(pythonVersion)'
          
          - script: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt -r requirements-dev.txt
            displayName: 'Install Dependencies'
          
          - script: |
              pytest tests/ -v --cov=app --cov-report=xml --cov-report=html --cov-report=term-missing
            displayName: 'Run Tests with Coverage'
          
          - task: PublishCodeCoverageResults@1
            displayName: 'Publish Code Coverage'
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: '$(System.DefaultWorkingDirectory)/coverage.xml'
              reportDirectory: '$(System.DefaultWorkingDirectory)/htmlcov'
          
          - task: PublishTestResults@2
            displayName: 'Publish Test Results'
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/test-*.xml'
              failTaskOnFailedTests: true

  - stage: DeployStaging
    displayName: 'Deploy to Staging'
    dependsOn: Test
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
    jobs:
      - deployment: DeployToStaging
        displayName: 'Deploy to Azure App Service (Staging Slot)'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'staging'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadBuildArtifacts@1
                  inputs:
                    buildType: 'current'
                    downloadType: 'single'
                    artifactName: 'drop'
                    downloadPath: '$(System.ArtifactsDirectory)'
                
                - task: AzureWebApp@1
                  displayName: 'Deploy to Azure Web App (Staging)'
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    appType: 'webAppLinux'
                    appName: '$(webAppName)'
                    deployToSlotOrASE: true
                    resourceGroupName: '$(resourceGroup)'
                    slotName: 'staging'
                    package: '$(System.ArtifactsDirectory)/drop/$(Build.BuildId).zip'
                    runtimeStack: 'PYTHON|3.13'
                    startUpCommand: 'python -m uvicorn app.main:app --host 0.0.0.0 --port 8000'

  - stage: DeployProduction
    displayName: 'Deploy to Production'
    dependsOn: Test
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployToProduction
        displayName: 'Deploy to Azure App Service (Production)'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadBuildArtifacts@1
                  inputs:
                    buildType: 'current'
                    downloadType: 'single'
                    artifactName: 'drop'
                    downloadPath: '$(System.ArtifactsDirectory)'
                
                - task: AzureRmWebAppDeployment@4
                  displayName: 'Run Database Migrations'
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    appType: 'webAppLinux'
                    WebAppName: '$(webAppName)'
                    packageForLinux: '$(System.ArtifactsDirectory)/drop/$(Build.BuildId).zip'
                    ScriptType: 'Inline Script'
                    InlineScript: |
                      python -m alembic upgrade head
                
                - task: AzureWebApp@1
                  displayName: 'Deploy to Azure Web App (Production)'
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    appType: 'webAppLinux'
                    appName: '$(webAppName)'
                    package: '$(System.ArtifactsDirectory)/drop/$(Build.BuildId).zip'
                    runtimeStack: 'PYTHON|3.13'
                    startUpCommand: 'python -m uvicorn app.main:app --host 0.0.0.0 --port 8000'
                
                - task: AzureAppServiceManage@0
                  displayName: 'Restart App Service'
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    Action: 'Restart Azure App Service'
                    WebAppName: '$(webAppName)'
